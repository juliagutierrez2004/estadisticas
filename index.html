<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scouting Pro - Bitácora</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; padding: 20px; border-radius: 15px; width: 100%; max-width: 600px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #reloj { font-size: 45px; font-weight: bold; text-align: center; margin: 10px 0; color: #1a73e8; }
        
        .jugador-card { border-bottom: 1px solid #eee; padding: 15px 0; }
        .nombre { font-size: 18px; font-weight: bold; margin-bottom: 8px; }
        .botones-agrupados { display: flex; gap: 8px; }
        
        button { border: none; border-radius: 6px; padding: 12px; font-weight: bold; cursor: pointer; }
        .btn-shot { background: #34a853; color: white; flex: 1; }
        .btn-turnover { background: #fbbc05; color: white; flex: 1; }
        .btn-timer { background: #1a73e8; color: white; padding: 10px 30px; }
        
        /* Estilos del Modal (Ventanita) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; text-align: center; width: 80%; max-width: 300px; }
        
        #reporte-invisible { display: none; padding: 30px; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    </style>
</head>
<body>

<div class="container">
    <div id="reloj">00:00</div>
    <div style="text-align:center; margin-bottom:20px;">
        <button class="btn-timer" onclick="toggleTiempo()" id="btnPlay">Iniciar Partido</button>
        <button style="background:#ddd" onclick="resetearTodo()">Reset</button>
    </div>

    <div id="lista-jugadores"></div>

    <button style="background:#ea4335; color:white; width:100%; margin-top:20px; padding:15px;" onclick="generarReporte()">FINALIZAR Y DESCARGAR PDF</button>
</div>

<div id="modalTiro" class="modal">
    <div class="modal-content">
        <h3>¿Resultado del tiro?</h3>
        <button style="background:#34a853; color:white; width:100%; margin-bottom:10px; padding:15px;" onclick="registrarTiro(true)">¡GOL / CONVERTIDO!</button>
        <button style="background:#ea4335; color:white; width:100%; padding:15px;" onclick="registrarTiro(false)">ERRADO</button>
        <br><br>
        <button style="background:#999; color:white;" onclick="cerrarModal()">Cancelar</button>
    </div>
</div>

<div id="reporte-invisible">
    <h1 id="pdf-titulo">Reporte Estadístico Detallado</h1>
    <p id="pdf-fecha"></p>
    <div id="pdf-bitacora">
        <h3>Bitácora de Eventos (Tiempo Real)</h3>
        <table id="tabla-eventos">
            <thead><tr><th>Tiempo</th><th>Jugador</th><th>Acción</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    let jugadores = [
        { id: 0, nombre: "Jugador 1", goles: 0, errados: 0, perdidas: 0 },
        { id: 1, nombre: "Jugador 2", goles: 0, errados: 0, perdidas: 0 },
        { id: 2, nombre: "Jugador 3", goles: 0, errados: 0, perdidas: 0 }
    ];
    let bitacora = [];
    let segundos = 0;
    let corriendo = false;
    let intervalo;
    let jugadorSeleccionado = null;

    window.onload = () => {
        const guardado = localStorage.getItem("scouting_data");
        if(guardado) {
            const data = JSON.parse(guardado);
            jugadores = data.jugadores;
            segundos = data.segundos;
            bitacora = data.bitacora || [];
            actualizarReloj();
        }
        dibujar();
    };

    function dibujar() {
        const lista = document.getElementById("lista-jugadores");
        lista.innerHTML = "";
        jugadores.forEach(j => {
            lista.innerHTML += `
                <div class="jugador-card">
                    <div class="nombre">${j.nombre} <small>(G: ${j.goles} | E: ${j.errados} | P: ${j.perdidas})</small></div>
                    <div class="botones-agrupados">
                        <button class="btn-shot" onclick="abrirModalTiro(${j.id})">LANZAMIENTO</button>
                        <button class="btn-turnover" onclick="registrarPerdida(${j.id})">PÉRDIDA</button>
                    </div>
                </div>`;
        });
        localStorage.setItem("scouting_data", JSON.stringify({jugadores, segundos, bitacora}));
    }

    function toggleTiempo() {
        corriendo = !corriendo;
        if(corriendo) {
            intervalo = setInterval(() => { segundos++; actualizarReloj(); }, 1000);
            document.getElementById("btnPlay").innerText = "Pausar";
        } else {
            clearInterval(intervalo);
            document.getElementById("btnPlay").innerText = "Reanudar";
        }
    }

    function actualizarReloj() {
        let m = Math.floor(segundos / 60); let s = segundos % 60;
        document.getElementById("reloj").innerText = `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
    }

    // Lógica de Lanzamientos
    function abrirModalTiro(id) { jugadorSeleccionado = id; document.getElementById("modalTiro").style.display = "flex"; }
    function cerrarModal() { document.getElementById("modalTiro").style.display = "none"; }

    function registrarTiro(entro) {
        const j = jugadores[jugadorSeleccionado];
        const tiempoActual = document.getElementById("reloj").innerText;
        if(entro) { j.goles++; } else { j.errados++; }
        bitacora.push({ tiempo: tiempoActual, nombre: j.nombre, accion: entro ? "Gol" : "Tiro Errado" });
        cerrarModal(); dibujar();
    }

    function registrarPerdida(id) {
        const j = jugadores[id];
        const tiempoActual = document.getElementById("reloj").innerText;
        j.perdidas++;
        bitacora.push({ tiempo: tiempoActual, nombre: j.nombre, accion: "Pérdida de balón" });
        dibujar();
    }

    function generarReporte() {
        document.getElementById("pdf-fecha").innerText = "Fecha: " + new Date().toLocaleString();
        const tbody = document.querySelector("#tabla-eventos tbody");
        tbody.innerHTML = "";
        // Invertimos la bitácora para que lo último aparezca primero si quieres, o normal:
        bitacora.forEach(e => {
            tbody.innerHTML += `<tr><td>${e.tiempo}</td><td>${e.nombre}</td><td>${e.accion}</td></tr>`;
        });
        
        const el = document.getElementById("reporte-invisible");
        el.style.display = "block";
        html2pdf().from(el).save("Scouting_Partido.pdf").then(() => el.style.display = "none");
    }

    function resetearTodo() { if(confirm("¿Borrar todo?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>
